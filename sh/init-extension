#!/bin/bash
# Extension initialization script
# Called by bsext_init during start

SCRIPT_DIR=$(dirname $(realpath $0))
EXTENSION_HOME=$(dirname ${SCRIPT_DIR})

echo "Initializing Python Development Extension..."

# Source the Python environment setup
if [ -f "${SCRIPT_DIR}/setup_python_env" ]; then
    # Source the environment setup (no cd needed - script is path-independent)
    source "${SCRIPT_DIR}/setup_python_env"
else
    echo "Error: setup_python_env not found at ${SCRIPT_DIR}/setup_python_env"
    exit 1
fi

# Install rknn-toolkit-lite2 wheel if present and not already installed
RKNN_WHEEL="${EXTENSION_HOME}/usr/lib/python3.8/wheels/rknn_toolkit_lite2-2.3.2-cp38-cp38-manylinux_2_17_aarch64.manylinux2014_aarch64.whl"
if [ -f "$RKNN_WHEEL" ]; then
    echo "Checking rknn-toolkit-lite2 installation..."
    if ! python3 -c "import rknnlite" 2>/dev/null; then
        echo "Installing rknn-toolkit-lite2..."
        if pip3 install --no-deps "$RKNN_WHEEL"; then
            echo "  Success: rknn-toolkit-lite2 installed"
        else
            echo "  Warning: Failed to install rknn-toolkit-lite2 (extension will continue)"
            logger -t "bsext-pydev" "RKNN toolkit installation failed but extension continues"
        fi
    else
        echo "  rknn-toolkit-lite2 already installed"
    fi
else
    echo "RKNN wheel not found, skipping RKNN installation"
fi

# Run user initialization if configured
if [ -x "${SCRIPT_DIR}/run-user-init" ]; then
    echo "Running user initialization..."
    if "${SCRIPT_DIR}/run-user-init"; then
        echo "  User initialization completed"
    else
        echo "  Warning: User initialization had errors (extension continues)"
        logger -t "bsext-pydev" "User initialization failed but extension continues"
    fi
else
    echo "User initialization script not found or not executable, skipping"
fi

echo "Python Development Extension initialized successfully"
exit 0